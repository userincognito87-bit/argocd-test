apiVersion: v1
kind: ConfigMap
metadata:
  name: argocd-notifications-cm
  namespace: argocd
data:
  # --- Telegram notifier ---
  service.telegram: |
    token: $telegram-token

  # --- Trigger when sync finishes ---
  trigger.on-sync-status-change: |
    - when: app.status.operationState.phase in ['Succeeded', 'Failed']
      send: [app-sync-status]

  # --- Template used for Telegram messages ---
  template.app-sync-status: |
    telegram:
      chatId: ""
      disable_web_page_preview: true
      message: |
        ðŸš€ *ArgoCD Sync {{.app.status.operationState.phase}}*
        *App:* {{.app.metadata.name}}
        *Namespace:* {{.app.metadata.namespace}}
        *Status:* {{.app.status.sync.status}}
        *Revision:* {{.app.status.operationState.sync.revision}}
        *Message:* {{.app.status.operationState.message}}

  # --- Subscription (which triggers use which service) ---
  subscriptions: |
    - recipients:
        - telegram
      triggers:
        - on-sync-status-change
